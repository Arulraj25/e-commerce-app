name: Deploy E-Commerce App

on:
  push:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker images
      run: |
        echo "ğŸ”¨ Building Docker images..."
        docker compose build
        echo "âœ… Images built successfully"

    - name: Test Application
      run: |
        echo "ğŸ³ Starting containers..."
        docker compose up -d
        
        echo "â³ Waiting for services to start..."
        sleep 30
        
        echo "ğŸ¥ Running health checks..."
        # Test backend
        if curl -f http://localhost:5000/health; then
          echo "âœ… Backend is healthy"
        else
          echo "âŒ Backend health check failed"
          exit 1
        fi
        
        # Test frontend
        if curl -f http://localhost:3000; then
          echo "âœ… Frontend is responding"
        else
          echo "âŒ Frontend check failed"
          exit 1
        fi
        
        echo "ğŸ§¹ Cleaning up..."
        docker compose down
        echo "ğŸ‰ All tests passed!"

    - name: Success Message
      if: success()
      run: echo "ğŸš€ CI Pipeline completed successfully! Your app is ready for deployment."
